# protoc-gen-weave
protoc plugin to generate some of the boiler plate associated with weave extension

## Usage

```proto
// test.proto
syntax = "proto3";

package blog;
import "github.com/gogo/protobuf/gogoproto/gogo.proto";
import "github.com/mwitkow/go-proto-validators/validator.proto";
import "github.com/lehajam/protoc-gen-weave/x/bucket/bucket.proto";

option (gogoproto.marshaler_all) = true;
option (gogoproto.sizer_all) = true;
option (gogoproto.unmarshaler_all) = true;

message Blog {
    string title = 1 [(validator.field) = {length_lt: 100}];
    // Author bytes to be interpreted as weave.Address
    repeated bytes authors = 2 [(validator.field) = {repeated_count_min: 1, repeated_count_max: 10}];
    int64 num_articles = 3  [(validator.field) = {int_gt: 0}];
}

message Post {
    string title = 1 [(validator.field) = {length_lt: 100}];
    bytes author = 2 [(bucket.index) = {name: "author", unique: false}];
    // a timestamp would differ between nodes and be
    // non-deterministic when replaying blocks.
    // block height is the only constant
    int64 creation_block = 3 [(validator.field) = {int_gt: 0}];
    string text = 4 [(validator.field) = {length_lt: 20000}];
}
```

```bash
protoc  \
	--proto_path=${GOPATH}/src \
	--proto_path=${GOPATH}/src/github.com/gogo/protobuf/protobuf \
	--proto_path=. \
	--gogo_out=. \
	--govalidators_out=gogoimport=true:. \
	--weave_out=gogoimport=true:. \
	*.proto
```

will generate `test.model.pb.go` as follow

```go
// Code generated by protoc-gen-gogo. DO NOT EDIT.
// source: test.proto

package blog

import github_com_iov_one_weave "github.com/iov-one/weave"
import github_com_iov_one_weave_orm "github.com/iov-one/weave/orm"
import github_com_jinzhu_copier "github.com/jinzhu/copier"
import proto "github.com/gogo/protobuf/proto"
import fmt "fmt"
import math "math"
import _ "github.com/gogo/protobuf/gogoproto"
import _ "github.com/lehajam/protoc-gen-weave/x/bucket"
import _ "github.com/mwitkow/go-proto-validators"

// Reference imports to suppress errors if they are not otherwise used.
var _ = proto.Marshal
var _ = fmt.Errorf
var _ = math.Inf

func (b *Blog) Copy() github_com_iov_one_weave_orm.CloneableData {
	var cpy *Blog
	github_com_jinzhu_copier.Copy(cpy, b)
	return cpy
}

const BlogBucketName = "blogs"

type BlogBucket struct {
	github_com_iov_one_weave_orm.Bucket
}

func NewBlogBucket() BlogBucket {
	bucket := github_com_iov_one_weave_orm.NewBucket(BlogBucketName,
		github_com_iov_one_weave_orm.NewSimpleObj(nil, new(Blog)))
	return BlogBucket{Bucket: bucket}
}

func (b BlogBucket) Save(db github_com_iov_one_weave.KVStore, obj github_com_iov_one_weave_orm.Object) error {
	if _, ok := obj.Value().(*Blog); !ok {
		return github_com_iov_one_weave_orm.ErrInvalidObject(obj.Value())
	}
	return b.Bucket.Save(db, obj)
}

func (b *Post) Copy() github_com_iov_one_weave_orm.CloneableData {
	var cpy *Post
	github_com_jinzhu_copier.Copy(cpy, b)
	return cpy
}

const PostBucketName = "posts"

type PostBucket struct {
	github_com_iov_one_weave_orm.Bucket
}

func NewPostBucket() PostBucket {
	bucket := github_com_iov_one_weave_orm.NewBucket(PostBucketName,
		github_com_iov_one_weave_orm.NewSimpleObj(nil, new(Post))).
		WithIndex("author", idxAuthor, false)
	return PostBucket{Bucket: bucket}
}

func (b PostBucket) Save(db github_com_iov_one_weave.KVStore, obj github_com_iov_one_weave_orm.Object) error {
	if _, ok := obj.Value().(*Post); !ok {
		return github_com_iov_one_weave_orm.ErrInvalidObject(obj.Value())
	}
	return b.Bucket.Save(db, obj)
}

func idxAuthor(obj github_com_iov_one_weave_orm.Object) ([]byte, error) {
	if obj == nil {
		return nil, fmt.Errorf("Cannot take index of nil")
	}
	objAs, ok := obj.Value().(*Post)
	if !ok {
		return nil, fmt.Errorf("Can only take index of objAs")
	}
	return objAs.Author, nil
}
```
